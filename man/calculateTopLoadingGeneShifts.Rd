% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculateTopLoadingGeneShifts.R,
%   R/plot.calculateTopLoadingGeneShifts.R
\name{calculateTopLoadingGeneShifts}
\alias{calculateTopLoadingGeneShifts}
\alias{plot.calculateTopLoadingGeneShiftsObject}
\title{Calculate Top Loading Gene Expression Shifts}
\usage{
calculateTopLoadingGeneShifts(
  query_data,
  reference_data,
  query_cell_type_col,
  ref_cell_type_col,
  cell_types = NULL,
  pc_subset = 1:5,
  n_top_loadings = 50,
  p_value_threshold = 0.05,
  adjust_method = "fdr",
  assay_name = "logcounts",
  max_cells = 2500
)

\method{plot}{calculateTopLoadingGeneShiftsObject}(
  x,
  cell_type,
  pc_subset = 1:3,
  plot_type = c("heatmap", "boxplot"),
  plot_by = c("p_adjusted", "top_loading"),
  n_genes = 10,
  significance_threshold = 0.05,
  ...
)
}
\arguments{
\item{query_data}{A \code{\linkS4class{SingleCellExperiment}} object containing numeric expression matrix for the query cells.}

\item{reference_data}{A \code{\linkS4class{SingleCellExperiment}} object containing numeric expression matrix for the reference cells.}

\item{query_cell_type_col}{The column name in the \code{colData} of \code{query_data} that identifies the cell types.}

\item{ref_cell_type_col}{The column name in the \code{colData} of \code{reference_data} that identifies the cell types.}

\item{cell_types}{A character vector specifying the cell types to analyze. If NULL, all common cell types are used.}

\item{pc_subset}{A numeric vector specifying which principal components to plot. Default is 1:3.}

\item{n_top_loadings}{Number of top loading genes to analyze per PC. Default is 50.}

\item{p_value_threshold}{P-value threshold for statistical significance. Default is 0.05.}

\item{adjust_method}{Method for multiple testing correction. Default is "fdr".}

\item{assay_name}{Name of the assay on which to perform computations. Default is "logcounts".}

\item{max_cells}{Maximum number of cells to retain. If the object has fewer cells, it is returned unchanged.
Default is 2500.}

\item{x}{An object of class \code{calculateTopLoadingGeneShiftsObject}.}

\item{cell_type}{A character string specifying the cell type to plot (must be exactly one).}

\item{plot_type}{A character string specifying visualization type. Either "heatmap" or "boxplot".
Default is "heatmap".}

\item{plot_by}{A character string specifying gene selection method when `n_genes` is not NULL.
Either "top_loading" or "p_adjusted". Default is "p_adjusted".}

\item{n_genes}{Number of top genes to show per PC. Can be NULL if `significance_threshold` is set.
Default is 10.}

\item{significance_threshold}{If not NULL, a numeric value between 0 and 1. Used for gene
selection or annotation. Default is 0.05.}

\item{...}{Additional arguments passed to \code{\link[ComplexHeatmap]{draw}} or not used for boxplot.}
}
\value{
A list containing:
\itemize{
  \item PC results: Named elements for each PC (e.g., "PC1", "PC2") containing data frames with gene-level analysis results.
  \item expression_data: Matrix of expression values for all analyzed genes (genes Ã— cells).
  \item cell_metadata: Data frame with columns: cell_id, dataset, cell_type, original_index.
  \item gene_metadata: Data frame with columns: gene, pc, loading for all analyzed genes.
  \item percent_var: Named numeric vector of global percent variance explained for each analyzed PC.
  \item cell_type_variance: A data frame detailing the percent of variance a global PC explains within specific cell types for both query and reference datasets.
}

The `cell_type_variance` data frame contains columns: pc, cell_type, dataset, percent_variance.

A plot object.
}
\description{
This function identifies genes with the highest loadings for specified principal components
and performs statistical tests to detect distributional differences between query and reference data.
It also calculates the proportion of variance explained by each principal component within
specific cell types.

This function creates visualizations showing expression distributions for top loading genes
that exhibit distributional differences between query and reference datasets. Can display
results as elegant complex heatmaps or as information-rich summary boxplots.
}
\details{
This function extracts the top loading genes for each specified principal component from the reference
PCA space and performs distributional comparisons between query and reference data. For each gene,
it performs statistical tests to identify genes that may be causing PC-specific alignment issues
between datasets. A key feature is the calculation of cell-type-specific variance explained by
global PCs, providing a more nuanced view of how major biological axes affect individual populations.

This function visualizes the results from \code{calculateTopLoadingGeneShifts}.
The "heatmap" option displays a hierarchically clustered set of genes.
The "boxplot" option creates a two-panel plot using `ggplot2`: the left panel shows
horizontal expression boxplots for up to 5 PCs, while the right panel displays their
corresponding PC loadings and adjusted p-values.
}
\seealso{
\code{\link{plot.calculateTopLoadingGeneShiftsObject}}

\code{\link{calculateTopLoadingGeneShifts}}
}
\author{
Anthony Christidis, \email{anthony-alexander_christidis@hms.harvard.edu}
}
